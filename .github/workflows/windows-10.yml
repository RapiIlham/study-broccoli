name: Windows QEMU Installation

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: ZeroTier
      uses: zerotier/github-action@v1.0.1
      with:
          network_id: ${{ secrets.ZEROTIER_NETWORK_ID }}

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: ~/
        key: ${{ runner.os }}-filess-${{ env.cache-name }}-${{ hashFiles('**/win10.iso') }}
        restore-keys: ${{ runner.os }}-filess-${{ env.cache-name }}-${{ hashFiles('**/win10.iso') }}

    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-system-x86 p7zip-full

    - name: Create virtual machine
      run: |
        qemu-img create -f qcow2 windows.qcow2 100G
        sudo timeout --foreground 5400 "qemu-system-x86_64 -m 10G -smp 4 -cdrom win10.iso -hda windows.qcow2 -enable-kvm -vnc 0.0.0.0:2"
